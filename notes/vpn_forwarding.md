# Forward all traffic from one VPN to another (DigitalOcean)

## Description
The steps below allow forwarding traffic from one VPN (OpenVPN) to another (l2tp in our case). We'll forward only specific subent: `10.126.0.0/16` 

## 1. Initiate l2tp vpn
```
apt update
apt install xl2tpd strongswan network-manager network-manager-l2tp net-tools
```

Create `/etc/netplan/01-network-manager-all.yaml`:
```
network:
  version: 2
  renderer: NetworkManager
```
Apply the changes:
```
sudo netplan --debug generate
sudo netplan apply
reboot
```

Check if eth0 is now in `managed` state:
```
nmcli device status
```

Create a new vpn connection:
```
nmcli c add con-name vpn1 connection.id vpn1 type vpn vpn-type l2tp connection.autoconnect yes ipv4.never-default true ipv4.routes "10.126.0.0/16" ipv6.method "disabled" vpn.data 'gateway=vpn.somesite.com, ipsec-enabled=yes, ipsec-psk=vpn-somekey, password-flags=0, user=team12345' vpn.secrets password=somePassW0rD
```

And restart the service:
```
service network-manager restart
```

Everything is ready, run your vpn: 
```nmcli connection up vpn1```

Stop: 
```nmcli connection down vpn1```

## 2. Install openvpn:
https://github.com/angristan/openvpn-install

To connect using openvpn v2 use [the following options](https://github.com/angristan/openvpn-install/blob/master/FAQ.md):
- No compression or LZ0
- RSA certificate
- DH Key
- AES CBC
- tls-auth

Add routes to your .ovpn config:
```
route-nopull
route 10.126.0.0 255.255.0.0
```

## 3. Setup forwarding from `tun0` to `ppp0`:
```
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -A FORWARD -i tun0 -o ppp0 -j ACCEPT
iptables -A FORWARD -i ppp0 -o tun0 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE
```





